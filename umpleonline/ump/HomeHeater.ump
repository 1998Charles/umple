// Home Heating System state machine written in Umple
// Source: Model Checking Template-Semantics Specifications (TR: CS-2004-20)
// University of Waterloo, Waterloo, Ontario, N2L 3G1
// Authors: Yun Lu, Joanne M. Atlee, Nancy A. Day, Jianwei Niu
// Date: April 05, 2004

class HeatControlSystem {

	int furnaceStartUpTime;
	const int FURNACETIMER = 5;
	int setTemp;
	int actualTemp;
	int waitedForWarm;
	const int WARMUPTIMER = 5;
	int valvePos;
	int waitedForCool;
	const int COOLDOWNTIMER = 5;

	//internally generated events
	boolean furnaceRunning;
	boolean activate;
	boolean deactivate;
	boolean requestHeat;
	boolean furnaceReset;


	sm {
		heatingSystem {
			house {
				room {
					noHeatReq {
						idleNotHeat {
							[(setTemp - actualTemp) > 2] / { valvePos++; waitedForWarm = 0; } ->	waitForHeat;					
						}
						waitForHeat {
							[waitedForWarm < WARMUPTIMER] /{ waitedForWarm++; } -> waitForHeat;
							[(valvePos != 2) & (waitedForWarm == WARMUPTIMER)] /{ valvePos++; waitedForWarm = 0; } -> waitForHeat;
							[!((setTemp - actualTemp) > 2)] -> idleNotHeat;
							[(waitedForWarm == WARMUPTIMER) & (valvePos == 2) & ((setTemp - actualTemp) > 2)] / { requestHeat = true; } -> heatReq;
						}
					}
					heatReq {
						idleHeat {
							[(actualTemp - setTemp) > 2]	/ { valvePos--; waitedForCool = 0; } ->	waitForCool;		
						}
						waitForCool {
							[(valvePos != 0) & (WARMUPTIMER == waitedForCool)] / { valvePos--; waitedForCool = 0; } -> waitForCool;	
                            [(valvePos == 0) & (WARMUPTIMER == waitedForCool) & ((actualTemp - setTemp) > 2)] / { requestHeat = false; } -> noHeatReq;
							[waitedForCool < WARMUPTIMER] / { waitedForCool++; } -> waitForCool;
							[!((actualTemp - setTemp) > 2)] -> idleHeat;
						}
					}
				}
				||
				controller {
					off {
						heatSwitchOn -> controllerOn;
					}
					controllerOn {
						heatSwitchOff / { deactivate = true; } -> off;
						furnaceFault -> error;
						idle {
							[requestHeat == true] / { activate = true; } -> heaterActive;
						}
						heaterActive {
							[requestHeat == false] / { deactivate = true; } -> idle;
							actHeater {
								[furnaceRunning == true] -> heaterRun;
							}
							heaterRun { }
						}
					}
					error {
						userReset / { furnaceReset = true; } -> off;
					}
				}
			}
			||
			furnace {
				furnaceNormal {
					furnaceFault -> furnaceErr;
					furnaceOff {
						[activate == true] / { furnaceStartUpTime = 0; } -> furnaceAct;
					}
					furnaceAct {
						[deactivate == true] -> furnaceOff;
						[furnaceStartUpTime < FURNACETIMER] / { furnaceStartUpTime++ } -> furnaceAct;
						[furnaceStartUpTime == FURNACETIMER] / { furnaceRunning = true; } -> furnaceRun;
					}
					furnaceRun {
						[deactivate == true] -> furnaceOff;
					}
				}
				furnaceErr {
					[furnaceReset == true] -> furnaceNormal;
				}
			}
		}
	}
}
